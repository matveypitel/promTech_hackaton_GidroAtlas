@inherits LayoutComponentBase
@inject IJSRuntime JS
@inject NavigationManager NavManager
@using GidroAtlas.Web.Interfaces
@inject IAuthApiService AuthService

<MudThemeProvider Theme="@_theme" IsDarkMode="true" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />
<MudLayout Class="dark">
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <div class="d-flex align-center gap-2 ml-3">
            <MudIcon Icon="@Icons.Material.Filled.Water" Color="Color.Primary" Size="Size.Medium" />
            <MudText Typo="Typo.h5" Style="font-weight: 700; color: white;">GidroAtlas</MudText>
        </div>
        <MudSpacer />
        
        @* Chat Bot Button - Expert only *@
        @if (_isExpert)
        {
            <MudTooltip Text="AI Помощник" Placement="Placement.Bottom">
                <MudIconButton Icon="@Icons.Material.Filled.SmartToy" 
                               Color="Color.Inherit" 
                               OnClick="@ToggleChatPanel"
                               Class="@($"chat-toggle-btn {(_isChatOpen ? "active" : "")}")" />
            </MudTooltip>
        }
        

        
        <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" Class="ml-2">
            <ActivatorContent>
                 <MudAvatar Color="Color.Secondary" Size="Size.Medium">@GetInitials()</MudAvatar>
            </ActivatorContent>
            <ChildContent>
                <div class="pa-4 min-w-[150px]">
                    <MudText Typo="Typo.body1" Class="font-bold">@UserName</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Default" Class="opacity-70">@UserRole</MudText>
                </div>
                <MudDivider />
                <MudMenuItem OnClick="Logout" Icon="@Icons.Material.Filled.Logout">Выйти</MudMenuItem>
            </ChildContent>
        </MudMenu>
    </MudAppBar>
    <MudDrawer id="nav-drawer" @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <NavMenu />
    </MudDrawer>
    <MudMainContent Class="pt-16 pa-4">
        @Body
    </MudMainContent>
</MudLayout>

@* Chat Panel Overlay - Expert only *@
@if (_isExpert)
{
    <div class="@($"chat-overlay {(_isChatOpen ? "visible" : "")}")" @onclick="CloseChatPanel"></div>
    <ChatPanel IsOpen="@_isChatOpen" OnClose="CloseChatPanel" />
}


<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private bool _drawerOpen = true;
    private bool _isChatOpen = false;
    private bool _isExpert = false;
    private MudTheme? _theme = null;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        _theme = new()
        {
            PaletteDark = _darkPalette,
            LayoutProperties = new LayoutProperties()
        };
    }

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private readonly PaletteDark _darkPalette = new()
    {
        Primary = "#137fec",
        Surface = "#192633",
        Background = "#101922",
        BackgroundGray = "#0d1419",
        AppbarText = "#92adc9",
        AppbarBackground = "rgba(16,25,34,0.95)",
        DrawerBackground = "#192633",
        ActionDefault = "#92adc9",
        ActionDisabled = "#324d674d",
        ActionDisabledBackground = "#2336484d",
        TextPrimary = "#ffffff",
        TextSecondary = "#92adc9",
        TextDisabled = "#ffffff33",
        DrawerIcon = "#92adc9",
        DrawerText = "#92adc9",
        GrayLight = "#233648",
        GrayLighter = "#192633",
        Info = "#137fec",
        Success = "#388E3C",
        Warning = "#FFA000",
        Error = "#D32F2F",
        LinesDefault = "#324d67",
        TableLines = "#324d67",
        Divider = "#324d67",
        OverlayLight = "#10192280",
    };

    private string UserName = "Guest";
    private string UserRole = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var storedName = await JS.InvokeAsync<string>("localStorage.getItem", "userName");
                var storedRole = await JS.InvokeAsync<string>("localStorage.getItem", "userRole");
                _isExpert = storedRole == "Expert";
                if (!string.IsNullOrEmpty(storedName))
                {
                    UserName = storedName;
                    UserRole = storedRole;
                    StateHasChanged();
                }
            }
            catch { /* ignore */ }
        }
    }

    private string GetInitials()
    {
        if (string.IsNullOrEmpty(UserName) || UserName == "Guest") return "?";
        return UserName.Substring(0, 1).ToUpper();
    }

    private async Task Logout()
    {
        await JS.InvokeVoidAsync("localStorage.removeItem", "authToken");
        await JS.InvokeVoidAsync("localStorage.removeItem", "userRole");
        await JS.InvokeVoidAsync("localStorage.removeItem", "userName");
        NavManager.NavigateTo("/", true);
    }

    private void ToggleChatPanel()
    {
        _isChatOpen = !_isChatOpen;
    }

    private void CloseChatPanel()
    {
        _isChatOpen = false;
    }
}
