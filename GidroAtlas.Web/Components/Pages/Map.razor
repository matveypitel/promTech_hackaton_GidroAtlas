@page "/map"
@inject IJSRuntime JS
@inject IDialogService DialogService
@using GidroAtlas.Shared.DTOs
@using GidroAtlas.Shared.Enums
@using GidroAtlas.Web.Interfaces
@inject IWaterObjectApiService WaterObjectApi
@implements IDisposable

<PageTitle>Карта водных ресурсов</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Карта водных ресурсов Казахстана</MudText>

    @if (loadError != null)
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">Ошибка загрузки данных: @loadError</MudAlert>
    }

    <MudPaper Elevation="3" Class="pa-4">
        <div id="map" style="height:600px; width:100%; border-radius: 8px;"></div>
    </MudPaper>
</MudContainer>

@code {
    private DotNetObjectReference<Map>? dotNetHelper;
    private List<WaterObjectDto> waterResources = new();
    private string? loadError;
    private bool isExpert;
    private string? authToken;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await WaterObjectApi.GetAllAsync(new WaterObjectFilterDto 
            { 
                PageSize = 1000 // Load all objects for the map
            });
            
            if (response != null)
            {
                waterResources = response.Items.ToList();
            }
            else
            {
                loadError = "Не удалось загрузить данные с сервера";
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message + (ex.InnerException != null ? $" Inner: {ex.InnerException.Message}" : "");
            Console.WriteLine($"Error loading map data: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            // Создаем ссылку на этот компонент для JS Interop
            dotNetHelper = DotNetObjectReference.Create(this);

            // Check role and get auth token
            var userRole = await JS.InvokeAsync<string>("localStorage.getItem", "userRole");
            isExpert = userRole == "Expert";
            
            authToken = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
            if (!string.IsNullOrEmpty(authToken))
            {
                WaterObjectApi.SetAuthToken(authToken);
            }

            // Start map
            await JS.InvokeVoidAsync("leafletMap.create", "map", 48.0, 67.0, 5);

            // Add markers
            foreach (var resource in waterResources)
            {
                // Guest sees condition 0 (Standard Marker), Expert sees real condition
                var conditionToPass = isExpert ? resource.TechnicalCondition : 0;

                await JS.InvokeVoidAsync("leafletMap.addMarker",
                    (double)resource.Latitude,
                    (double)resource.Longitude,
                    resource.Name,
                    resource.Id.ToString(),
                    conditionToPass,
                    resource.Region);

                // Устанавливаем callback для клика по маркеру
                await JS.InvokeVoidAsync("leafletMap.setMarkerClickCallback", dotNetHelper, resource.Id.ToString());
            }

            Console.WriteLine("Map initialized successfully");
        }
        catch (JSException ex)
        {
            Console.WriteLine($"JSInterop error: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task OnMarkerClicked(string resourceId)
    {
        if (!Guid.TryParse(resourceId, out var id))
            return;
            
        var selectedResource = waterResources.FirstOrDefault(r => r.Id == id);
        if (selectedResource != null)
        {
            var parameters = new DialogParameters<WaterResourceDialog>
            {
                { x => x.Resource, selectedResource },
                { x => x.WaterObjectApi, WaterObjectApi },
                { x => x.IsExpert, isExpert },
                { x => x.OnUpdated, EventCallback.Factory.Create<WaterObjectDto>(this, HandleWaterObjectUpdated) }
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true
            };

            await DialogService.ShowAsync<WaterResourceDialog>("Информация о водном ресурсе", parameters, options);
        }
    }

    private async Task HandleWaterObjectUpdated(WaterObjectDto updatedResource)
    {
        // Update local list
        var index = waterResources.FindIndex(r => r.Id == updatedResource.Id);
        if (index >= 0)
        {
            waterResources[index] = updatedResource;
        }

        // Update marker on the map
        try
        {
            // Remove old marker and add updated one
            await JS.InvokeVoidAsync("leafletMap.removeMarker", updatedResource.Id.ToString());
            
            var conditionToPass = isExpert ? updatedResource.TechnicalCondition : 0;
            await JS.InvokeVoidAsync("leafletMap.addMarker",
                (double)updatedResource.Latitude,
                (double)updatedResource.Longitude,
                updatedResource.Name,
                updatedResource.Id.ToString(),
                conditionToPass,
                updatedResource.Region);
            
            await JS.InvokeVoidAsync("leafletMap.setMarkerClickCallback", dotNetHelper, updatedResource.Id.ToString());
            
            Console.WriteLine($"Map marker updated for: {updatedResource.Name}");
        }
        catch (JSException ex)
        {
            Console.WriteLine($"Error updating map marker: {ex.Message}");
        }
        
        StateHasChanged();
    }

    public void Dispose()
    {
        dotNetHelper?.Dispose();
    }
}
