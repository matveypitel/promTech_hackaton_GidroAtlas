@page "/map"
@inject IJSRuntime JS
@inject IDialogService DialogService
@using GidroAtlas.Shared.DTOs
@using GidroAtlas.Shared.Enums
@using GidroAtlas.Web.Interfaces
@inject IWaterObjectApiService WaterObjectApi
@implements IDisposable

<PageTitle>Карта водных ресурсов</PageTitle>

<div class="map-page bg-background-dark font-display p-6 min-h-screen">
    <div class="max-w-full mx-auto">
        <header class="mb-4">
            <p class="text-white text-3xl font-black leading-tight tracking-[-0.033em]">Карта водных ресурсов Казахстана</p>
        </header>

        @if (loadError != null)
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">Ошибка загрузки данных: @loadError</MudAlert>
        }

        <!-- Search and Filter Panel -->
        <div class="flex flex-col gap-4 mb-4">
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <div class="flex-grow w-full md:w-auto">
                    <label class="flex flex-col min-w-40 h-12 w-full">
                        <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                            <div class="text-text-secondary-dark flex bg-interactive-dark items-center justify-center pl-4 rounded-l-lg">
                                <span class="material-symbols-outlined">search</span>
                            </div>
                            <input @bind="searchText" @bind:event="oninput" @onkeyup="ApplyFilters" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-r-lg !text-white focus:outline-0 focus:ring-2 focus:ring-primary focus:ring-inset border-none !bg-interactive-dark h-full placeholder:text-text-secondary-dark px-4 text-base font-normal leading-normal" placeholder="Поиск по названию объекта"/>
                        </div>
                    </label>
                </div>
                <button @onclick="RefreshData" class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-primary/20 text-primary px-4 hover:bg-primary/30 transition-colors">
                    <span class="material-symbols-outlined text-sm">refresh</span>
                    <p class="text-sm font-medium">Обновить</p>
                </button>
                <button @onclick="ClearFilters" class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-red-500/20 text-red-400 px-4 hover:bg-red-500/30 transition-colors">
                    <span class="material-symbols-outlined text-sm">filter_alt_off</span>
                    <p class="text-sm font-medium">Сбросить</p>
                </button>
            </div>
            
            <!-- Filters Row -->
            <div class="flex flex-wrap gap-3 items-center">
                <!-- Region Filter -->
                <div class="relative">
                    <select @bind="selectedRegion" @bind:after="ApplyFilters" class="appearance-none h-10 w-full min-w-[140px] bg-interactive-dark text-white rounded-lg pl-4 pr-10 hover:bg-interactive-dark/80 transition-colors focus:outline-none focus:ring-2 focus:ring-primary cursor-pointer">
                        <option value="">Все области</option>
                        @foreach (var region in availableRegions)
                        {
                            <option value="@region">@region</option>
                        }
                    </select>
                    <span class="material-symbols-outlined text-white absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-lg">expand_more</span>
                </div>

                <!-- Water Type Filter -->
                <div class="relative">
                    <select @bind="selectedWaterType" @bind:after="ApplyFilters" class="appearance-none h-10 w-full min-w-[140px] bg-interactive-dark text-white rounded-lg pl-4 pr-10 hover:bg-interactive-dark/80 transition-colors focus:outline-none focus:ring-2 focus:ring-primary cursor-pointer">
                        <option value="">Все типы воды</option>
                        <option value="Fresh">Пресная</option>
                        <option value="NonFresh">Непресная</option>
                    </select>
                    <span class="material-symbols-outlined text-white absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-lg">expand_more</span>
                </div>

                @if (isExpert)
                {
                    <!-- Condition Filter -->
                    <div class="relative">
                        <select @bind="selectedCondition" @bind:after="ApplyFilters" class="appearance-none h-10 w-full min-w-[180px] bg-interactive-dark text-white rounded-lg pl-4 pr-10 hover:bg-interactive-dark/80 transition-colors focus:outline-none focus:ring-2 focus:ring-primary cursor-pointer">
                            <option value="">Все состояния</option>
                            <option value="1">Отличное (1)</option>
                            <option value="2">Хорошее (2)</option>
                            <option value="3">Удовлетворительное (3)</option>
                            <option value="4">Неудовлетворительное (4)</option>
                            <option value="5">Критическое (5)</option>
                        </select>
                        <span class="material-symbols-outlined text-white absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-lg">expand_more</span>
                    </div>
                }

                <!-- Has Fauna Filter -->
                <div class="relative">
                    <select @bind="selectedHasFauna" @bind:after="ApplyFilters" class="appearance-none h-10 w-full min-w-[140px] bg-interactive-dark text-white rounded-lg pl-4 pr-10 hover:bg-interactive-dark/80 transition-colors focus:outline-none focus:ring-2 focus:ring-primary cursor-pointer">
                        <option value="">Фауна: все</option>
                        <option value="true">С фауной</option>
                        <option value="false">Без фауны</option>
                    </select>
                    <span class="material-symbols-outlined text-white absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-lg">expand_more</span>
                </div>

                <!-- Results counter -->
                <div class="ml-auto text-text-secondary-dark text-sm">
                    Показано объектов: <span class="text-white font-medium">@displayedObjects.Count</span> из @allWaterObjects.Count
                </div>
            </div>
        </div>

        <!-- Layer Toggle -->
        <div class="flex justify-center mb-4">
            <MudToggleGroup T="string" Value="@selectedLayer" ValueChanged="@OnLayerChanged" Color="Color.Primary" CheckMark="true" FixedContent="true">
                <MudToggleItem Value="@("resources")">
                    <MudStack Row="true" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Water" />
                        <MudText>Водные ресурсы</MudText>
                    </MudStack>
                </MudToggleItem>
                <MudToggleItem Value="@("structures")">
                    <MudStack Row="true" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Construction" />
                        <MudText>Гидротехнические сооружения</MudText>
                    </MudStack>
                </MudToggleItem>
            </MudToggleGroup>
        </div>

        <!-- Map Container -->
        <div class="rounded-xl overflow-hidden border border-border-dark bg-surface-dark">
            <div id="map" style="height:600px; width:100%;"></div>
        </div>

    @* Легенда карты *@
    @if (isExpert)
    {
        <MudPaper Elevation="4" Class="pa-5 mt-4" Style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 16px;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.Map" Style="color: #64b5f6; font-size: 1.75rem;" />
                <MudText Typo="Typo.h6" Style="color: #ffffff; font-weight: 600; margin-left: 12px;">
                    Техническое состояние объектов
                </MudText>
            </MudStack>

            <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center" Class="flex-wrap" Justify="Justify.FlexStart">
                @* Отличное состояние *@
                <div class="legend-item" style="background: linear-gradient(145deg, #2e7d32 0%, #4CAF50 50%, #66bb6a 100%); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);">
                    <div class="legend-icon" style="background: rgba(255,255,255,0.25);">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: #fff; font-size: 1.1rem;" />
                    </div>
                    <div class="legend-content">
                        <span class="legend-text">1 Отличное</span>
                    </div>
                </div>

                @* Хорошее состояние *@
                <div class="legend-item" style="background: linear-gradient(145deg, #689f38 0%, #8BC34A 50%, #9ccc65 100%); box-shadow: 0 4px 15px rgba(139, 195, 74, 0.4);">
                    <div class="legend-icon" style="background: rgba(255,255,255,0.25);">
                        <MudIcon Icon="@Icons.Material.Filled.ThumbUp" Style="color: #fff; font-size: 1.1rem;" />
                    </div>
                    <div class="legend-content">
                        <span class="legend-text">2 Хорошее</span>
                    </div>
                </div>

                @* Удовлетворительное состояние *@
                <div class="legend-item" style="background: linear-gradient(145deg, #f9a825 0%, #FFEB3B 50%, #ffee58 100%); box-shadow: 0 4px 15px rgba(255, 235, 59, 0.4);">
                    <div class="legend-icon" style="background: rgba(0,0,0,0.15);">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Style="color: #5d4037; font-size: 1.1rem;" />
                    </div>
                    <div class="legend-content">
                        <span class="legend-text" style="color: #3e2723;">3 Удовлетворит.</span>
                    </div>
                </div>

                @* Неудовлетворительное состояние *@
                <div class="legend-item" style="background: linear-gradient(145deg, #ef6c00 0%, #FF9800 50%, #ffb74d 100%); box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);">
                    <div class="legend-icon" style="background: rgba(255,255,255,0.25);">
                        <MudIcon Icon="@Icons.Material.Filled.Warning" Style="color: #fff; font-size: 1.1rem;" />
                    </div>
                    <div class="legend-content">
                        <span class="legend-text">4 Неудовл.</span>
                    </div>
                </div>

                @* Критическое состояние *@
                <div class="legend-item" style="background: linear-gradient(145deg, #c62828 0%, #F44336 50%, #ef5350 100%); box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);">
                    <div class="legend-icon" style="background: rgba(255,255,255,0.25);">
                        <MudIcon Icon="@Icons.Material.Filled.Error" Style="color: #fff; font-size: 1.1rem;" />
                    </div>
                    <div class="legend-content">
                        <span class="legend-text"> 5 Критическое</span>
                    </div>
                </div>
            </MudStack>
        </MudPaper>

        <style>
            .legend-item {
                display: flex;
                align-items: center;
                padding: 10px 16px;
                border-radius: 12px;
                min-width: 140px;
                transition: all 0.3s ease;
                cursor: default;
            }
            
            .legend-item:hover {
                transform: translateY(-2px);
                filter: brightness(1.1);
            }
            
            .legend-icon {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 10px;
                flex-shrink: 0;
            }
            
            .legend-content {
                display: flex;
                flex-direction: column;
                line-height: 1.2;
            }
            
            .legend-number {
                font-size: 0.75rem;
                font-weight: 700;
                color: rgba(255,255,255,0.9);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .legend-text {
                font-size: 0.9rem;
                font-weight: 600;
                color: #ffffff;
                text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            }
        </style>
    }
    </div>
</div>

@code {
    private DotNetObjectReference<Map>? dotNetHelper;
    private List<WaterObjectDto> allWaterObjects = new();
    private List<WaterObjectDto> displayedObjects = new();
    private string? loadError;
    private bool isExpert;
    private string? authToken;
    private string selectedLayer = "resources"; // "resources" or "structures"
    
    // Search and Filter variables
    private string searchText = "";
    private List<string> availableRegions = new();
    private string selectedRegion = "";
    private string selectedWaterType = "";
    private string selectedCondition = "";
    private string selectedHasFauna = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load all data from API
            var response = await WaterObjectApi.GetAllAsync(new WaterObjectFilterDto 
            { 
                PageSize = 2000 // Load enough to cover all
            });
            
            if (response != null && response.Items != null)
            {
                allWaterObjects = response.Items.ToList();
                // Extract unique regions for filter dropdown
                availableRegions = allWaterObjects
                    .Select(x => x.Region)
                    .Where(r => !string.IsNullOrEmpty(r))
                    .Distinct()
                    .Order()
                    .ToList();
            }
            
            FilterObjects();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
            Console.WriteLine($"Error loading map data: {ex.Message}");
        }
    }

    private void OnLayerChanged(string layer)
    {
        selectedLayer = layer;
        FilterObjects();
        _ = UpdateMapMarkers();
        StateHasChanged();
    }

    private void FilterObjects()
    {
        IEnumerable<WaterObjectDto> filtered = allWaterObjects;
        
        // Filter by layer (resources vs structures)
        if (selectedLayer == "structures")
        {
            filtered = filtered.Where(x => x.ResourceType == ResourceType.HydroTechnicalStructure);
        }
        else
        {
            filtered = filtered.Where(x => x.ResourceType != ResourceType.HydroTechnicalStructure);
        }
        
        // Search by name
        if (!string.IsNullOrWhiteSpace(searchText))
        {
            filtered = filtered.Where(x => x.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase));
        }
        
        // Filter by region
        if (!string.IsNullOrEmpty(selectedRegion))
        {
            filtered = filtered.Where(x => x.Region == selectedRegion);
        }
        
        // Filter by water type
        if (!string.IsNullOrEmpty(selectedWaterType) && Enum.TryParse<WaterType>(selectedWaterType, out var wt))
        {
            filtered = filtered.Where(x => x.WaterType == wt);
        }
        
        // Filter by technical condition
        if (!string.IsNullOrEmpty(selectedCondition) && int.TryParse(selectedCondition, out var condition))
        {
            filtered = filtered.Where(x => x.TechnicalCondition == condition);
        }
        
        // Filter by fauna
        if (!string.IsNullOrEmpty(selectedHasFauna))
        {
            bool hasFauna = selectedHasFauna == "true";
            filtered = filtered.Where(x => x.HasFauna == hasFauna);
        }
        
        displayedObjects = filtered.ToList();
    }
    
    private async Task ApplyFilters()
    {
        FilterObjects();
        await UpdateMapMarkers();
        StateHasChanged();
    }
    
    private async Task RefreshData()
    {
        try
        {
            loadError = null;
            var response = await WaterObjectApi.GetAllAsync(new WaterObjectFilterDto 
            { 
                PageSize = 2000
            });
            
            if (response != null && response.Items != null)
            {
                allWaterObjects = response.Items.ToList();
                availableRegions = allWaterObjects
                    .Select(x => x.Region)
                    .Where(r => !string.IsNullOrEmpty(r))
                    .Distinct()
                    .Order()
                    .ToList();
            }
            
            FilterObjects();
            await UpdateMapMarkers();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
            Console.WriteLine($"Error refreshing map data: {ex.Message}");
        }
    }
    
    private async Task ClearFilters()
    {
        searchText = "";
        selectedRegion = "";
        selectedWaterType = "";
        selectedCondition = "";
        selectedHasFauna = "";
        FilterObjects();
        await UpdateMapMarkers();
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            dotNetHelper = DotNetObjectReference.Create(this);

            var userRole = await JS.InvokeAsync<string>("localStorage.getItem", "userRole");
            isExpert = userRole == "Expert";
            
            authToken = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
            if (!string.IsNullOrEmpty(authToken))
            {
                WaterObjectApi.SetAuthToken(authToken);
            }

            StateHasChanged();

            await JS.InvokeVoidAsync("leafletMap.create", "map", 48.0, 67.0, 5);
            await UpdateMapMarkers(); 
        }
        catch (JSException ex)
        {
            Console.WriteLine($"JSInterop error: {ex.Message}");
        }
    }

    private async Task UpdateMapMarkers()
    {
        // Try to clear markers, but don't stop execution if it fails (e.g. old JS cached)
        try 
        {
            await JS.InvokeVoidAsync("leafletMap.clearMarkers");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Warning: Failed to clear markers (possibly cached JS): {ex.Message}");
        }

        try
        {
            Console.WriteLine($"Updating markers. Displayed objects count: {displayedObjects.Count}");
            
            foreach (var resource in displayedObjects)
            {
                // Role-Based Visualization Logic
                // Expert: Sees actual Technical Condition (1-5) -> Colored Circle
                // Guest: Sees 0 -> Standard Icon (Neutral)
                
                int visualCondition = 0;

                if (isExpert)
                {
                    visualCondition = resource.TechnicalCondition;
                }
                else
                {
                    visualCondition = 0;
                }

                await JS.InvokeVoidAsync("leafletMap.addMarker",
                    (double)resource.Latitude,
                    (double)resource.Longitude,
                    resource.Name,
                    resource.Id.ToString(),
                    visualCondition,
                    resource.Region);

                await JS.InvokeVoidAsync("leafletMap.setMarkerClickCallback", dotNetHelper, resource.Id.ToString());
            }
        }
        catch (Exception ex)
        {
             Console.WriteLine($"Error adding markers: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task OnMarkerClicked(string resourceId)
    {
        if (!Guid.TryParse(resourceId, out var id))
            return;
            
        var selectedResource = allWaterObjects.FirstOrDefault(r => r.Id == id);
        if (selectedResource != null)
        {
            var parameters = new DialogParameters<WaterResourceDialog>
            {
                { x => x.Resource, selectedResource },
                { x => x.WaterObjectApi, WaterObjectApi },
                { x => x.IsExpert, isExpert },
                { x => x.OnUpdated, EventCallback.Factory.Create<WaterObjectDto>(this, HandleWaterObjectUpdated) }
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true
            };

            await DialogService.ShowAsync<WaterResourceDialog>("Информация о водном ресурсе", parameters, options);
        }
    }

    private async Task HandleWaterObjectUpdated(WaterObjectDto updatedResource)
    {
        var index = allWaterObjects.FindIndex(r => r.Id == updatedResource.Id);
        if (index >= 0)
        {
            allWaterObjects[index] = updatedResource;
        }
        
        FilterObjects();
        await UpdateMapMarkers();
        
        StateHasChanged();
    }

    public void Dispose()
    {
        dotNetHelper?.Dispose();
    }
}
