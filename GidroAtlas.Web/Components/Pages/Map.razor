@page "/map"
@inject IJSRuntime JS
@inject IDialogService DialogService
@using GidroAtlas.Api.Infrastructure.Database
@using GidroAtlas.Api.Entities
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@implements IDisposable

<PageTitle>Карта водных ресурсов</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Карта водных ресурсов Казахстана</MudText>

    @if (loadError != null)
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">Ошибка загрузки данных: @loadError</MudAlert>
    }

    <MudPaper Elevation="3" Class="pa-4">
        <div id="map" style="height:600px; width:100%; border-radius: 8px;"></div>
    </MudPaper>
</MudContainer>

@code {
    private DotNetObjectReference<Map>? dotNetHelper;

    // Список водных ресурсов
    private List<WaterResource> waterResources = new();
    private string? loadError;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var entities = await DbContext.WaterObjects.AsNoTracking().ToListAsync();
            waterResources = entities.Select(e => new WaterResource
            {
                Id = e.Id.ToString(),
                Name = e.Name,
                Region = e.Region,
                ResourceType = (ResourceType)(int)e.ResourceType,
                WaterType = (WaterType)(int)e.WaterType,
                HasFauna = e.HasFauna,
                PassportDate = e.PassportDate,
                TechnicalCondition = e.TechnicalCondition,
                Latitude = e.Latitude,
                Longitude = e.Longitude
            }).ToList();
        }
        catch (Exception ex)
        {
            loadError = ex.Message + (ex.InnerException != null ? $" Inner: {ex.InnerException.Message}" : "");
            Console.WriteLine($"Error loading map data: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            // Создаем ссылку на этот компонент для JS Interop
            dotNetHelper = DotNetObjectReference.Create(this);

            // Start map
            await JS.InvokeVoidAsync("leafletMap.create", "map", 48.0, 67.0, 5);

            // Check role
            var userRole = await JS.InvokeAsync<string>("localStorage.getItem", "userRole");
            var isAdmin = userRole == "Expert";

            // Add markers
            foreach (var resource in waterResources)
            {
                // Guest sees condition 0 (Standard Marker), Expert sees real condition
                var conditionToPass = isAdmin ? resource.TechnicalCondition : 0;

                await JS.InvokeVoidAsync("leafletMap.addMarker",
                    resource.Latitude,
                    resource.Longitude,
                    resource.Name,
                    resource.Id,
                    conditionToPass,
                    resource.Region);

                // Устанавливаем callback для клика по маркеру
                await JS.InvokeVoidAsync("leafletMap.setMarkerClickCallback", dotNetHelper, resource.Id);
            }

            Console.WriteLine("Map initialized successfully");
        }
        catch (JSException ex)
        {
            Console.WriteLine($"JSInterop error: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task OnMarkerClicked(string resourceId)
    {
        var selectedResource = waterResources.FirstOrDefault(r => r.Id == resourceId);
        if (selectedResource != null)
        {
            var parameters = new DialogParameters<WaterResourceDialog>
            {
                { x => x.Resource, selectedResource }
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true
            };

            await DialogService.ShowAsync<WaterResourceDialog>("Информация о водном ресурсе", parameters, options);
        }
    }

    public void Dispose()
    {
        dotNetHelper?.Dispose();
    }

    // Модели данных
    public class WaterResource
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Region { get; set; } = string.Empty;
        public ResourceType ResourceType { get; set; }
        public WaterType WaterType { get; set; }
        public bool HasFauna { get; set; }
        public DateTime PassportDate { get; set; }
        public int TechnicalCondition { get; set; } // 1-5
        public double Latitude { get; set; }
        public double Longitude { get; set; }
    }

    public enum ResourceType
    {
        Lake,
        Canal,
        Reservoir
    }

    public enum WaterType
    {
        Fresh,
        NonFresh,
        Mixed
    }
}
